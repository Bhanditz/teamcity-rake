<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="rakerunner-teamcity" default="dist">
    <!--plugin name-->
    <property name="plugin" value="rake-runner"/>
    <property name="build.vcs.number.1" value="local"/>

    <!--Dist libraries -->
    <property name="teamcity.dist" value="../../dist"/>
    <property name="rakerunner.libs" value="lib"/>
    <property name="rakerunner.libs.dist" value="${rakerunner.libs}/dist"/>
    <property name="rakerunner.ruby.src" value="${rakerunner.libs}/rakeRunnerRuby"/>

    <!--For external buildserver-->
    <property name="dist" value="${basedir}/dist"/>

<!--for TC build script-->
    <target name="dist">
      <ant antfile="build-common.xml" target="dist">
        <property name="plugin" value="${plugin}"/>
        <property name="teamcity.dist" value="${teamcity.dist}"/>
        <property name="dist" value="${dist}"/>
      </ant>

  <!--PATCH: Add ruby files-->
      <!-- Remove existing plugin bundle -->
      <delete file="${dist}/${plugin}-plugin.zip"/>
      <!-- Pack rb files to agent part of runner -->
      <jar destfile="${dist}/unpacked/${plugin}-agent.jar" update="true">
            <zipfileset dir="${rakerunner.ruby.src}" prefix="rb" />
      </jar>
      <!-- Recreate plugin bundle from unpacked directory -->
      <ant antfile="build-common.xml" target="layout plugin bundle">
        <property name="plugin" value="${plugin}"/>
        <property name="dist" value="${dist}"/>
      </ant>
      <!--Set build and vcs version  -->
      <copyfile src="teamcity-plugin.xml" dest="${dist}/teamcity-plugin.xml" />
      <replace file="${dist}/teamcity-plugin.xml" token="REVISION" value="${build.vcs.number.1}"/>  
      <zip destfile="${dist}/${plugin}-plugin.zip" update="true">
        <zipfileset file="${dist}/teamcity-plugin.xml"/>
      </zip>

      <!-- Sources zip -->
      <zip destfile="${dist}/${plugin}-src.zip" update="true">
        <zipfileset dir="${rakerunner.ruby.src}" prefix="${plugin}-agent/src/rb"/>
        <zipfileset file="${dist}/teamcity-plugin.xml"/>
      </zip>
      <delete file="${dist}/teamcity-plugin.xml"/>
    </target>

    <!--Update jar from TeamCity distributive-->
    <target name="update-jars-from-dist">
      <ant antfile="build-common.xml" target="update-jars-from-dist">
        <property name="plugin" value="${plugin}"/>
        <property name="teamcity.dist" value="${teamcity.dist}"/>
        <property name="dist" value="${dist}"/>
      </ant>
    </target>

<!-- Rake runner ruby part -->
    <target name="unpack rakeRunnerRuby-src.zip">
        <delete dir="${rakerunner.ruby.src}"/>
        <unzip dest="${rakerunner.ruby.src}">
            <fileset dir=".">
                <include name="${rakerunner.libs.dist}/rakeRunnerRuby-src.zip"/>
            </fileset>
        </unzip>
    </target>

    <target name="pack-rakeRunnerRuby-src.zip">
        <!-- Bundle -->
        <zip destfile="${rakerunner.libs.dist}/rakeRunnerRuby-src.zip">
            <!-- Ruby sources -->
            <zipfileset dir="${rakerunner.ruby.src}"/>
        </zip>
    </target>

<!-- Unpacker for TeamCity libaries -->
    <target name="unpack TeamCity-*.tar.gz">
        <!-- Extract TeamCity -->
        <delete dir="${teamcity.dist}"/>
        <untar compression="gzip" dest="${rakerunner.libs}">
            <fileset dir=".">
                <include name="${rakerunner.libs.dist}/TeamCity-*.tar.gz"/>
            </fileset>
        </untar>
    </target>

<!--Build task for external buildserver  -->
  <target name="build.artifacts" depends="unpack TeamCity-*.tar.gz,unpack rakeRunnerRuby-src.zip, dist"/>
</project>
