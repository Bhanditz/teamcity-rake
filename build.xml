<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="rakerunner-teamcity" default="dist">
    <!-- External directories -->
    <property name="rakerunner.bin.dir" value="dist/RakeRunner/bin"/>
    <property name="plugin.revision" value="${build.vcs.number.1}"/>
    <property name="plugin.version" value="${rake.runner.plugin.version}.${plugin.revision}"/>
    <!-- For devel-deploy -->
    <!--<property name="webrootdir" value="c:/soft/Teamcity_6527/webapps/ROOT"/>-->
    <!--<property name="agentdir" value="c:/soft/Teamcity_6527/buildAgent"/>-->

    <!-- TeamCity libraries -->
    <!--<property name="tc.root.dir" value="dist/TeamCity"/>-->

    <property name="tc.lib.dir" value="${tc.root.dir}/webapps/ROOT/WEB-INF/lib"/>
    <property name="tc.agentlib.dir" value="${tc.root.dir}/buildAgent/lib"/>
    <property name="tc.classes.dir" value="${tc.lib.dir}/../classes"/>
    <property name="tc.extras.dir" value="${tc.root.dir}/side"/>

    <property name="artifacts.dir" location="build/artifacts"/>
    <property name="artifacts.components.dir" location="${artifacts.dir}/components"/>

    <property name="webapp.dir" value="webapps"/>
    <property name="artifacts.plugin.server.part.file" location="${artifacts.components.dir}/${webapp.dir}/ROOT/WEB-INF/lib/rakeRunnerPluginServer.jar"/>
    <property name="artifacts.plugin.agent.part.file" location="${artifacts.components.dir}/${webapp.dir}/ROOT/update/plugins/rakeRunnerPluginAgent.zip"/>
    <property name="artifacts.plugin.webapp.dir" location="${artifacts.components.dir}/webapps"/>
    <property name="artifacts.plugin.readme.file" location="${artifacts.components.dir}/Readme.txt"/>

    <!-- Project Libraries -->
    <path id="classpath">
        <pathelement path="${tc.classes.dir}"/>
        <pathelement location="${tc.lib.dir}/annotations.jar"/>
        <pathelement location="${tc.lib.dir}/common-api.jar"/>
        <pathelement location="${tc.lib.dir}/log4j-1.2.12.jar"/>
        <pathelement location="${tc.lib.dir}/openapi.jar"/>
        <pathelement location="${tc.lib.dir}/server.jar"/>
        <pathelement location="${tc.lib.dir}/server-api.jar"/>
        <pathelement location="${tc.lib.dir}/util.jar"/>
        <pathelement location="${tc.lib.dir}/xstream-1.2.1.jar"/>
        <pathelement location="${tc.lib.dir}/xmlrpc-2.0.1.jar"/>

        <pathelement location="${tc.agentlib.dir}/agent.jar"/>
        <pathelement location="${tc.agentlib.dir}/agent-api.jar"/>
        <pathelement location="${tc.agentlib.dir}/server-logging.jar"/>
        <pathelement location="${tc.agentlib.dir}/runtime-util.jar"/>
    </path>

    <target name="clean">
        <delete dir="build"/>
    </target>

    <!-- Compile -->
    <target name="make-common">
        <mkdir dir="build/common/classes"/>
        <javac srcdir="common/src" debug="on" destdir="build/common/classes">
            <classpath refid="classpath"/>
        </javac>

         <jar destfile="build/jar/RakeRunnerCommon.jar">
            <fileset dir="build/common/classes"/>
        </jar>

    </target>

    <target name="make-agent">
        <!-- Java sources -->
        <mkdir dir="build/agent/classes"/>
        <javac srcdir="agent/src" debug="on" destdir="build/agent/classes">
            <classpath path="build/common/classes"/>
            <classpath refid="classpath"/>
        </javac>

        <!-- Agent Jar -->
        <jar destfile="build/jar/RakeRunnerPluginAgent.jar">
            <fileset dir="build/agent/classes"/>
            <fileset dir="agent/resources"/>
        </jar>

        <!-- Bundle -->
        <zip destfile="build/jar/rakeRunnerPluginAgent.zip">
            <zipfileset dir="build/version" prefix="rakeRunnerPluginAgent/version"/>
            <zipfileset dir="build/jar" includes="RakeRunnerPluginAgent.jar, RakeRunnerCommon.jar"
                        prefix="rakeRunnerPluginAgent/lib"/>
            <!-- Ruby sources -->
            <zipfileset dir="agent/src/rb" prefix="rakeRunnerPluginAgent/lib/rb"/>
        </zip>
    </target>

    <target name="make-server">
        <mkdir dir="build/server/classes"/>      
        <javac srcdir="server/src" debug="on" destdir="build/server/classes">
            <classpath path="build/common/classes"/>
            <classpath refid="classpath"/>
        </javac>

        <jar destfile="build/jar/rakeRunnerPluginServer.jar">
            <fileset dir="build/server/classes"/>
            <fileset dir="server/resources"/>
            <fileset dir="build" includes="version; version/**/*" />
        </jar>
    </target>

    <target name="make-bundle">
        <!-- Bundle -->
        <zip destfile="build/rakeRunnerPlugin.zip">
            <zipfileset file="build/jar/rakeRunnerPluginServer.jar"/>
            <zipfileset file="build/jar/rakeRunnerPluginAgent.zip"/>
            <!-- Readme -->
            <zipfileset file="README.txt"/>
        </zip>
    </target>

    <target name="make">
        <mkdir dir="build/jar"/>
        <mkdir dir="build/version"/>
        <echo file="build/version/${plugin.version}.txt" append="false"/>
        <antcall target="make-common"/>
        <antcall target="make-agent"/>
        <antcall target="make-server"/>
        <antcall target="make-bundle"/>
    </target>

    <!-- Dist -->
    <target name="dist" depends="clean,Unpack rakeRunnerRuby-src.zip,make"/>
    <target name="dist_full" depends="clean,Unpack TeamCity-*.tar.gz,Unpack rakeRunnerRuby-src.zip,make"/>
    <target name="dist2" depends="clean,dist-rakeRunnerRuby-src.zip,Unpack rakeRunnerRuby-src.zip,make"/>

    <!-- Deploy -->
    <target name="devel-deploy" depends="build.artifacts">
        <copy file="${artifacts.plugin.server.part.file}" todir="${webrootdir}/WEB-INF/lib"/>
        <copy file="${artifacts.plugin.agent.part.file}" todir="${webrootdir}/update/plugins"/>
        <unzip src="${artifacts.plugin.agent.part.file}" dest="${agentdir}/plugins"/>
    </target>

    <!-- Reload On Agent Deploy -->
    <target name="devel-reload_on_agent-deploy" depends="build.artifacts">
        <delete includeEmptyDirs="true">
            <fileset dir="${agentdir}/plugins/rakeRunnerPluginAgent" excludes="**/*.jar"/>
        </delete>
        <unzip src="${artifacts.plugin.agent.part.file}" dest="${agentdir}/plugins">
            <patternset>
                <include name="**/*.rb"/>
            </patternset>
        </unzip>
    </target>

    <!-- Un-deploy -->
    <target name="devel-undeploy">
        <delete file="${webrootdir}/WEB-INF/lib/rakeRunnerPluginServer.jar"/>
        <delete file="${webrootdir}/update/plugins/rakeRunnerPluginAgent.zip"/>
        <delete dir="${agentdir}/plugins/rakeRunnerPluginAgent"/>
    </target>

    <target name="build.artifacts" depends="dist_full">
        <mkdir dir="${artifacts.dir}"/>

        <copy file ="README.txt" tofile="${artifacts.plugin.readme.file}"/>

        <move file ="build/jar/rakeRunnerPluginServer.jar" tofile="${artifacts.plugin.server.part.file}"/>
        <move file ="build/jar/rakeRunnerPluginAgent.zip" tofile="${artifacts.plugin.agent.part.file}"/>

        <!-- Bundle -->
        <zip destfile="${artifacts.dir}/rakeRunnerPlugin-${plugin.version}.zip">
            <zipfileset dir="${artifacts.plugin.webapp.dir}" prefix="${webapp.dir}" />
            <!-- Readme -->
            <zipfileset file="${artifacts.plugin.readme.file}"/>
        </zip>
    </target>

    <!-- Rake runner ruby part -->
    <target name="Unpack rakeRunnerRuby-src.zip">
        <delete dir="dist/rakeRunnerRuby"/>
        <unzip dest="dist/rakeRunnerRuby">
            <fileset dir=".">
                <include name="dist/rakeRunnerRuby-src.zip"/>
            </fileset>
        </unzip>
    </target>

    <target name="dist-rakeRunnerRuby-src.zip">
        <!-- Bundle -->
        <zip destfile="dist/rakeRunnerRuby-src.zip">
            <!-- Ruby sources -->
            <zipfileset dir="rakerunner/src"/>
        </zip>
    </target>


    <!-- TeamCity builds -->
    <target name="Unpack TeamCity-*.tar.gz">
        <!-- Extract TeamCity -->
        <delete dir="${tc.root.dir}"/>
        <untar compression="gzip" dest="dist">
            <fileset dir=".">
                <include name="dist/tc/TeamCity-*.tar.gz"/>
            </fileset>
        </untar>

        <!-- Extract RakeRunner -->
        <delete dir="dist/RakeRunner"/>
        <mkdir dir="dist/RakeRunner"/>
        <unzip dest="dist/RakeRunner">
            <fileset dir=".">
                <include name="dist/RakeRunner-*.zip"/>
            </fileset>
        </unzip>
    </target>
</project>
